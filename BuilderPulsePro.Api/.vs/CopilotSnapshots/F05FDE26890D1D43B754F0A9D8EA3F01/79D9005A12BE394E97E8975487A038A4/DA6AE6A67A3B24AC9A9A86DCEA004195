using BuilderPulsePro.Api.Data;
using BuilderPulsePro.Api.Domain;
using BuilderPulsePro.Api.Events;
using Microsoft.EntityFrameworkCore;

namespace BuilderPulsePro.Api.Notifications;

public sealed class EnqueueJobPostedDigestItems(AppDbContext db) : IEventHandler<JobPosted>
{
    public async Task HandleAsync(JobPosted evt, CancellationToken ct)
    {
        var job = await db.Jobs.AsNoTracking()
            .Where(j => j.Id == evt.JobId)
            .Select(j => new { j.Id, j.Trade, j.SiteLocation, j.PostedByUserId })
            .FirstOrDefaultAsync(ct);

        if (job is null) return;

        var normalizedTrade = (job.Trade ?? "").Trim().ToLowerInvariant();
        if (string.IsNullOrWhiteSpace(normalizedTrade)) return;

        var patternMiddle = $"%,{normalizedTrade},%";
        var patternStart = $"{normalizedTrade},%";
        var patternEnd = $"%,{normalizedTrade}";

        var candidates = await db.ContractorProfiles.AsNoTracking()
            .Where(p =>
                p.UserId != job.PostedByUserId
                && p.HomeBase.Distance(job.SiteLocation) <= p.ServiceRadiusMeters
                && (
                    p.TradesCsv == normalizedTrade
                    || EF.Functions.ILike(p.TradesCsv, patternMiddle)
                    || EF.Functions.ILike(p.TradesCsv, patternStart)
                    || EF.Functions.ILike(p.TradesCsv, patternEnd)
                ))
            .Select(p => p.UserId)
            .ToListAsync(ct);

        if (candidates.Count == 0) return;

        var now = DateTimeOffset.UtcNow;

        foreach (var contractorUserId in candidates.Distinct())
        {
            db.ContractorJobNotifications.Add(new ContractorJobNotification
            {
                Id = Guid.NewGuid(),
                ContractorUserId = contractorUserId,
                JobId = job.Id,
                CreatedAt = now
            });
        }

        try
        {
            await db.SaveChangesAsync(ct);
        }
        catch (DbUpdateException)
        {
            // Ignore duplicate enqueue attempts (unique index prevents duplicates).
        }
    }
}
