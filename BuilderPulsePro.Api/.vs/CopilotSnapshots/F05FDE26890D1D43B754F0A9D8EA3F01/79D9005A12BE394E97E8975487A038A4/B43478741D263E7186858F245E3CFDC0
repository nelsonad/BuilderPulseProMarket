using BuilderPulsePro.Api.Data;
using BuilderPulsePro.Api.Domain;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace BuilderPulsePro.Api.Notifications;

public sealed class JobPostedDigestBackgroundService(
    IServiceScopeFactory scopeFactory,
    ILogger<JobPostedDigestBackgroundService> log) : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        var delay = TimeSpan.FromMinutes(10);

        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                await RunOnce(stoppingToken);
            }
            catch (Exception ex)
            {
                log.LogError(ex, "Job digest background service failed.");
            }

            await Task.Delay(delay, stoppingToken);
        }
    }

    private async Task RunOnce(CancellationToken ct)
    {
        using var scope = scopeFactory.CreateScope();

        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        var userManager = scope.ServiceProvider.GetRequiredService<UserManager<AppUser>>();
        var email = scope.ServiceProvider.GetRequiredService<IEmailSender>();

        var contractorIds = await db.ContractorJobNotifications.AsNoTracking()
            .Where(n => n.SentAt == null)
            .Select(n => n.ContractorUserId)
            .Distinct()
            .Take(200)
            .ToListAsync(ct);

        foreach (var contractorUserId in contractorIds)
        {
            var pending = await db.ContractorJobNotifications
                .Where(n => n.ContractorUserId == contractorUserId && n.SentAt == null)
                .Join(db.Jobs.AsNoTracking(),
                    n => n.JobId,
                    j => j.Id,
                    (n, j) => new
                    {
                        NotificationId = n.Id,
                        j.Id,
                        j.Title,
                        j.Trade,
                        j.CreatedAt
                    })
                .OrderByDescending(x => x.CreatedAt)
                .Take(25)
                .ToListAsync(ct);

            if (pending.Count == 0) continue;

            var user = await userManager.FindByIdAsync(contractorUserId.ToString());
            var to = user?.Email;
            if (string.IsNullOrWhiteSpace(to))
            {
                await MarkSent(db, pending.Select(x => x.NotificationId).ToList(), ct);
                continue;
            }

            var subject = $"New jobs in your area ({pending.Count})";

            var lines = pending
                .Select(x => $"- {x.Trade}: {x.Title}")
                .ToArray();

            var body =
                $"""
                You have {pending.Count} new job(s) in your service area:

                {string.Join(Environment.NewLine, lines)}

                Open the app to view details and place bids.
                """;

            await email.SendAsync(new EmailMessage(to, subject, body), ct);

            await MarkSent(db, pending.Select(x => x.NotificationId).ToList(), ct);
        }
    }

    private static async Task MarkSent(AppDbContext db, List<Guid> notificationIds, CancellationToken ct)
    {
        var now = DateTimeOffset.UtcNow;

        var rows = await db.ContractorJobNotifications
            .Where(n => notificationIds.Contains(n.Id))
            .ToListAsync(ct);

        foreach (var r in rows)
            r.SentAt = now;

        await db.SaveChangesAsync(ct);
    }
}
