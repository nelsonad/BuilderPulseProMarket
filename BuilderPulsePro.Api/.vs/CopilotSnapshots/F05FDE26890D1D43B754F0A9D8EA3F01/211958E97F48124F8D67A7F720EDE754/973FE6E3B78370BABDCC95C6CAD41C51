using Microsoft.Extensions.DependencyInjection;

namespace BuilderPulsePro.Api.Events;

public sealed class InProcessEventBus(IServiceProvider sp) : IEventBus
{
    public async Task PublishAsync<TEvent>(TEvent evt, CancellationToken ct = default)
        where TEvent : IDomainEvent
    {
        // Resolve all handlers for this event type and run them sequentially
        // (simple, predictable; can parallelize later)
        var handlers = sp.GetServices<IEventHandler<TEvent>>();
        foreach (var h in handlers)
            await h.HandleAsync(evt, ct);
    }
}
